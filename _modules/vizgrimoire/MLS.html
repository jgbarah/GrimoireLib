<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>vizgrimoire.MLS &mdash; GrimoreLib 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="GrimoreLib 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">GrimoreLib 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for vizgrimoire.MLS</h1><div class="highlight"><pre>
<span class="c">## Copyright (C) 2014 Bitergia</span>
<span class="c">##</span>
<span class="c">## This program is free software; you can redistribute it and/or modify</span>
<span class="c">## it under the terms of the GNU General Public License as published by</span>
<span class="c">## the Free Software Foundation; either version 3 of the License, or</span>
<span class="c">## (at your option) any later version.</span>
<span class="c">##</span>
<span class="c">## This program is distributed in the hope that it will be useful,</span>
<span class="c">## but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c">## GNU General Public License for more details. </span>
<span class="c">##</span>
<span class="c">## You should have received a copy of the GNU General Public License</span>
<span class="c">## along with this program; if not, write to the Free Software</span>
<span class="c">## Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="c">##</span>
<span class="c">## This file is a part of the vizGrimoire R package</span>
<span class="c">##  (an R library for the MetricsGrimoire and vizGrimoire systems)</span>
<span class="c">##</span>
<span class="c">## Authors:</span>
<span class="c">##   Daniel Izquierdo &lt;dizquierdo@bitergia.com&gt;</span>
<span class="c">##   Alvaro del Castillo &lt;acso@bitergia.com&gt;</span>

<span class="c">#############</span>
<span class="c"># TODO: missing functions wrt </span>
<span class="c">#       evolution and agg values of countries and companies</span>
<span class="c">#############</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">GrimoireSQL</span> <span class="kn">import</span> <span class="n">GetSQLGlobal</span><span class="p">,</span> <span class="n">GetSQLPeriod</span>
<span class="kn">from</span> <span class="nn">GrimoireSQL</span> <span class="kn">import</span> <span class="n">ExecuteQuery</span><span class="p">,</span> <span class="n">BuildQuery</span>
<span class="kn">from</span> <span class="nn">GrimoireUtils</span> <span class="kn">import</span> <span class="n">GetPercentageDiff</span><span class="p">,</span> <span class="n">GetDates</span><span class="p">,</span> <span class="n">completePeriodIds</span><span class="p">,</span> <span class="n">getPeriod</span><span class="p">,</span> <span class="n">createJSON</span><span class="p">,</span> <span class="n">get_subprojects</span>

<span class="kn">from</span> <span class="nn">data_source</span> <span class="kn">import</span> <span class="n">DataSource</span>
<span class="kn">import</span> <span class="nn">report</span>
<span class="kn">from</span> <span class="nn">filter</span> <span class="kn">import</span> <span class="n">Filter</span>


<div class="viewcode-block" id="MLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS">[docs]</a><span class="k">class</span> <span class="nc">MLS</span><span class="p">(</span><span class="n">DataSource</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_repo_field"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_repo_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_repo_field</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">&quot;mailing_list_url&quot;</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_db_name"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_db_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_db_name</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">&quot;db_mlstats&quot;</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_name"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">():</span> <span class="k">return</span> <span class="s">&quot;mls&quot;</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_evolutionary_data"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_evolutionary_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_evolutionary_data</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">filter_</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">rfield</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_repo_field</span><span class="p">()</span>
        <span class="n">evol</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">filter_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">filter_</span><span class="o">.</span><span class="n">get_item</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">EvolMLSInfo</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
            <span class="n">evol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evol</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">EvolMLSInfo</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">evol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evol</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    
            <span class="n">data</span>  <span class="o">=</span> <span class="n">EvolMLSCompanies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>
            <span class="n">evol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evol</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">EvolMLSCountries</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>
            <span class="n">evol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evol</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">EvolMLSDomains</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>
            <span class="n">evol</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">evol</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">evol</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.create_evolutionary_report"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.create_evolutionary_report">[docs]</a>    <span class="k">def</span> <span class="nf">create_evolutionary_report</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="n">i_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span>  <span class="n">MLS</span><span class="o">.</span><span class="n">get_evolutionary_data</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">i_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">MLS</span><span class="p">()</span><span class="o">.</span><span class="n">get_evolutionary_filename</span><span class="p">()</span>
        <span class="n">createJSON</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_agg_data"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_agg_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_agg_data</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">filter_</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">rfield</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_repo_field</span><span class="p">()</span>


        <span class="k">if</span> <span class="p">(</span><span class="n">filter_</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="n">StaticMLSInfo</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="c"># Tendencies</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">365</span><span class="p">]:</span>
                <span class="n">period_data</span> <span class="o">=</span> <span class="n">GetDiffSentDays</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">agg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">period_data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">period_data</span> <span class="o">=</span> <span class="n">GetDiffSendersDays</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">agg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">period_data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="c"># Last Activity: to be removed</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">365</span><span class="p">,</span><span class="mi">730</span><span class="p">]:</span>
                <span class="n">period_activity</span> <span class="o">=</span> <span class="n">lastActivity</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">agg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">period_activity</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">AggMLSCompanies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">AggMLSCountries</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">AggMLSDomains</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">agg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">filter_</span><span class="o">.</span><span class="n">get_item</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">]</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="n">StaticMLSInfo</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">agg</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.create_agg_report"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.create_agg_report">[docs]</a>    <span class="k">def</span> <span class="nf">create_agg_report</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="n">i_db</span><span class="p">,</span> <span class="n">filter_</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_agg_data</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">i_db</span><span class="p">,</span> <span class="n">filter_</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">MLS</span><span class="p">()</span><span class="o">.</span><span class="n">get_agg_filename</span><span class="p">()</span>
        <span class="n">createJSON</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_top_data"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_top_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_data</span> <span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">filter_</span><span class="p">,</span> <span class="n">npeople</span><span class="p">):</span>
        <span class="n">bots</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_bots</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filter_</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">top</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">top</span><span class="p">[</span><span class="s">&#39;senders.&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">top_senders</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span><span class="n">identities_db</span><span class="p">,</span><span class="n">bots</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
            <span class="n">top</span><span class="p">[</span><span class="s">&#39;senders.last year&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">top_senders</span><span class="p">(</span><span class="mi">365</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">bots</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
            <span class="n">top</span><span class="p">[</span><span class="s">&#39;senders.last month&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">top_senders</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span><span class="n">identities_db</span><span class="p">,</span><span class="n">bots</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">filter_</span><span class="o">.</span><span class="n">get_item</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;company&quot;</span><span class="p">):</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">companyTopSenders</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;country&quot;</span><span class="p">):</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">countryTopSenders</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;domain&quot;</span><span class="p">):</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">domainTopSenders</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;repository&quot;</span><span class="p">):</span>
                <span class="n">rfield</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_repo_field</span><span class="p">()</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">repoTopSenders</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">top</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">top</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.create_top_report"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.create_top_report">[docs]</a>    <span class="k">def</span> <span class="nf">create_top_report</span> <span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="n">npeople</span><span class="p">,</span> <span class="n">i_db</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_top_data</span> <span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">i_db</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
        <span class="n">top_file</span> <span class="o">=</span> <span class="n">destdir</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">MLS</span><span class="p">()</span><span class="o">.</span><span class="n">get_top_filename</span><span class="p">()</span>
        <span class="n">createJSON</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">top_file</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_filter_items"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_filter_items">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter_items</span><span class="p">(</span><span class="n">filter_</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">bots</span><span class="p">):</span>
        <span class="n">rfield</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_repo_field</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;repository&quot;</span><span class="p">):</span>
            <span class="n">items</span>  <span class="o">=</span> <span class="n">reposNames</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>  
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;company&quot;</span><span class="p">):</span>
            <span class="n">items</span>  <span class="o">=</span> <span class="n">companiesNames</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;country&quot;</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">countriesNames</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;domain&quot;</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">domainsNames</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;project&quot;</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">get_projects_mls_name</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">filter_name</span> <span class="o">+</span> <span class="s">&quot; not supported&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">items</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_filter_summary"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_filter_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_filter_summary</span><span class="p">(</span><span class="n">filter_</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;company&quot;</span><span class="p">):</span>
            <span class="n">summary</span> <span class="o">=</span>  <span class="n">GetSentSummaryCompanies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">summary</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.create_filter_report"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.create_filter_report">[docs]</a>    <span class="k">def</span> <span class="nf">create_filter_report</span><span class="p">(</span><span class="n">filter_</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="n">npeople</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">bots</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_filter_items</span><span class="p">(</span><span class="n">filter_</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">bots</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span> <span class="k">return</span>

        <span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>

        <span class="n">items_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="s">&quot;__&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span><span class="s">&quot;___&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">filter_</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">MLS</span><span class="p">()))</span>
        <span class="n">createJSON</span><span class="p">(</span><span class="n">items_files</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;domain&quot;</span><span class="p">,</span> <span class="s">&quot;company&quot;</span><span class="p">,</span> <span class="s">&quot;repository&quot;</span><span class="p">):</span>
            <span class="n">items_list</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;sent_365&#39;</span> <span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;senders_365&#39;</span> <span class="p">:</span> <span class="p">[]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">items_list</span> <span class="o">=</span> <span class="n">items</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span> <span class="p">:</span>
            <span class="n">item_name</span> <span class="o">=</span> <span class="s">&quot;&#39;&quot;</span><span class="o">+</span> <span class="n">item</span><span class="o">+</span> <span class="s">&quot;&#39;&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="n">item_name</span><span class="p">)</span>
            <span class="n">filter_item</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">(</span><span class="n">filter_</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">item</span><span class="p">)</span>

            <span class="n">evol_data</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_evolutionary_data</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> 
                                                  <span class="n">identities_db</span><span class="p">,</span> <span class="n">filter_item</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">filter_item</span><span class="o">.</span><span class="n">get_evolutionary_filename</span><span class="p">(</span><span class="n">MLS</span><span class="p">()))</span>
            <span class="n">createJSON</span><span class="p">(</span><span class="n">evol_data</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

            <span class="n">agg</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_agg_data</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">filter_item</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">filter_item</span><span class="o">.</span><span class="n">get_static_filename</span><span class="p">(</span><span class="n">MLS</span><span class="p">()))</span>
            <span class="n">createJSON</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;domain&quot;</span><span class="p">,</span> <span class="s">&quot;company&quot;</span><span class="p">,</span> <span class="s">&quot;repository&quot;</span><span class="p">):</span>
                <span class="n">items_list</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span><span class="s">&quot;__&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span><span class="s">&quot;___&quot;</span><span class="p">))</span>
                <span class="n">items_list</span><span class="p">[</span><span class="s">&#39;sent_365&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agg</span><span class="p">[</span><span class="s">&#39;sent_365&#39;</span><span class="p">])</span>
                <span class="n">items_list</span><span class="p">[</span><span class="s">&#39;senders_365&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agg</span><span class="p">[</span><span class="s">&#39;senders_365&#39;</span><span class="p">])</span>

            <span class="n">top_senders</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_top_data</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">filter_item</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>
            <span class="n">createJSON</span><span class="p">(</span><span class="n">top_senders</span><span class="p">,</span> <span class="n">destdir</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">filter_item</span><span class="o">.</span><span class="n">get_top_filename</span><span class="p">(</span><span class="n">MLS</span><span class="p">()))</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destdir</span><span class="p">,</span> <span class="n">filter_</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">MLS</span><span class="p">()))</span>
        <span class="n">createJSON</span><span class="p">(</span><span class="n">items_list</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">filter_name</span> <span class="o">==</span> <span class="s">&quot;company&quot;</span><span class="p">):</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_filter_summary</span><span class="p">(</span><span class="n">filter_</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">createJSON</span> <span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="n">destdir</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">filter_</span><span class="o">.</span><span class="n">get_summary_filename</span><span class="p">(</span><span class="n">MLS</span><span class="p">))</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_top_people"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_top_people">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_people</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">npeople</span><span class="p">):</span>
        <span class="n">top_data</span> <span class="o">=</span> <span class="n">MLS</span><span class="o">.</span><span class="n">get_top_data</span> <span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">npeople</span><span class="p">)</span>

        <span class="n">top</span> <span class="o">=</span> <span class="n">top_data</span><span class="p">[</span><span class="s">&#39;senders.&#39;</span><span class="p">][</span><span class="s">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">top</span> <span class="o">+=</span> <span class="n">top_data</span><span class="p">[</span><span class="s">&#39;senders.last year&#39;</span><span class="p">][</span><span class="s">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">top</span> <span class="o">+=</span> <span class="n">top_data</span><span class="p">[</span><span class="s">&#39;senders.last month&#39;</span><span class="p">][</span><span class="s">&quot;id&quot;</span><span class="p">]</span>
        <span class="c"># remove duplicates</span>
        <span class="n">people</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">top</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">people</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_person_evol"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_person_evol">[docs]</a>    <span class="k">def</span> <span class="nf">get_person_evol</span><span class="p">(</span><span class="n">upeople_id</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">):</span>
        <span class="n">evol</span> <span class="o">=</span> <span class="n">GetEvolPeopleMLS</span><span class="p">(</span><span class="n">upeople_id</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="n">evol</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">evol</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">evol</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_person_agg"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_person_agg">[docs]</a>    <span class="k">def</span> <span class="nf">get_person_agg</span><span class="p">(</span><span class="n">upeople_id</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">GetStaticPeopleMLS</span><span class="p">(</span><span class="n">upeople_id</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.create_r_reports"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.create_r_reports">[docs]</a>    <span class="k">def</span> <span class="nf">create_r_reports</span><span class="p">(</span><span class="n">vizr</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">destdir</span><span class="p">):</span>
        <span class="n">unique_ids</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">vizr</span><span class="o">.</span><span class="n">ReportDemographicsAgingMLS</span><span class="p">(</span><span class="n">enddate</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="n">unique_ids</span><span class="p">)</span>
        <span class="n">vizr</span><span class="o">.</span><span class="n">ReportDemographicsBirthMLS</span><span class="p">(</span><span class="n">enddate</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="n">unique_ids</span><span class="p">)</span>

        <span class="c">## Which quantiles we&#39;re interested in</span>
        <span class="c"># quantiles_spec = [0.99,0.95,0.5,0.25]</span>

        <span class="c">## Yearly quantiles of time to attention (minutes)</span>
        <span class="c">## Monthly quantiles of time to attention (hours)</span>
        <span class="c">## JSON files generated from VizR</span>
        <span class="n">vizr</span><span class="o">.</span><span class="n">ReportTimeToAttendMLS</span><span class="p">(</span><span class="n">destdir</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MLS.get_metrics_definition"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.MLS.get_metrics_definition">[docs]</a>    <span class="k">def</span> <span class="nf">get_metrics_definition</span> <span class="p">():</span>
        <span class="n">mdef</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;mls_responses&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_responses&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;responses&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Reply messages&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of messages that are resplies (not first in thread) in mailing list(s)&quot;</span>
            <span class="p">},</span>
            <span class="s">&quot;mls_sent&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_sent&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;sent&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Posted messages&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of messages posted to mailing list(s)&quot;</span>
            <span class="p">},</span>
            <span class="s">&quot;mls_senders&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_senders&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;senders&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Message posters&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of persons posting messages in mailing list(s)&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span> <span class="p">:</span> <span class="s">&quot;sent&quot;</span>
            <span class="p">},</span>
            <span class="s">&quot;mls_threads&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_threads&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;message_id&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Message threads&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of messages threads in mailing lists 3&quot;</span><span class="p">,</span>
                <span class="s">&quot;action&quot;</span> <span class="p">:</span> <span class="s">&quot;length&quot;</span><span class="p">,</span>
                <span class="s">&quot;initiator_name&quot;</span> <span class="p">:</span> <span class="s">&quot;Initiator&quot;</span><span class="p">,</span>
                <span class="s">&quot;length&quot;</span> <span class="p">:</span> <span class="s">&quot;Messages&quot;</span>
            <span class="p">},</span>
            <span class="s">&quot;mls_companies&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_companies&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;companies&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Organizations&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of organizations (companies, etc.) with persons active in mailing list(s)&quot;</span>
            <span class="p">},</span>
            <span class="s">&quot;mls_countries&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_countries&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;countries&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Countries&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of countries with persons active in mailing list(s)&quot;</span>
            <span class="p">},</span>
            <span class="s">&quot;mls_domains&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_domains&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;domains&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Domains&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of distinct domains with persons active in mailing list(s)&quot;</span>
            <span class="p">},</span>
            <span class="s">&quot;mls_repositories&quot;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="s">&quot;divid&quot;</span> <span class="p">:</span> <span class="s">&quot;mls_repositories&quot;</span><span class="p">,</span>
                <span class="s">&quot;column&quot;</span> <span class="p">:</span> <span class="s">&quot;repositories&quot;</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span> <span class="p">:</span> <span class="s">&quot;Mailing lists&quot;</span><span class="p">,</span>
                <span class="s">&quot;desc&quot;</span> <span class="p">:</span> <span class="s">&quot;Number of active mailing lists&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">mdef</span>

<span class="c">##############</span>
<span class="c"># Specific FROM and WHERE clauses per type of report</span>
<span class="c">##############</span>
</div></div>
<div class="viewcode-block" id="GetMLSSQLRepositoriesFrom"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLRepositoriesFrom">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLRepositoriesFrom</span> <span class="p">():</span>
    <span class="c"># tables necessary for repositories</span>
    <span class="c">#return (&quot; messages m &quot;) </span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetMLSSQLRepositoriesWhere"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLRepositoriesWhere">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLRepositoriesWhere</span> <span class="p">(</span><span class="n">repository</span><span class="p">):</span>
    <span class="c"># fields necessary to match info among tables</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&quot; m.mailing_list_url = &quot;</span><span class="o">+</span><span class="n">repository</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="GetMLSSQLCompaniesFrom"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLCompaniesFrom">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLCompaniesFrom</span> <span class="p">(</span><span class="n">i_db</span><span class="p">):</span>
    <span class="c"># fields necessary for the companies analysis</span>

    <span class="k">return</span><span class="p">(</span><span class="s">&quot; , messages_people mp, &quot;</span><span class="o">+</span>\
                   <span class="s">&quot;people_upeople pup, &quot;</span><span class="o">+</span>\
                   <span class="n">i_db</span><span class="o">+</span><span class="s">&quot;.companies c, &quot;</span><span class="o">+</span>\
                   <span class="n">i_db</span><span class="o">+</span><span class="s">&quot;.upeople_companies upc&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetMLSSQLCompaniesWhere"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLCompaniesWhere">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLCompaniesWhere</span> <span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c"># filters for the companies analysis</span>
    <span class="k">return</span><span class="p">(</span><span class="s">&quot; m.message_ID = mp.message_id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;mp.email_address = pup.people_id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s"> and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;pup.upeople_id = upc.upeople_id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;upc.company_id = c.id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;m.first_date &gt;= upc.init and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;m.first_date &lt; upc.end and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;c.name = &quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetMLSSQLCountriesFrom"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLCountriesFrom">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLCountriesFrom</span> <span class="p">(</span><span class="n">i_db</span><span class="p">):</span>
    <span class="c"># fields necessary for the countries analysis</span>
    <span class="k">return</span><span class="p">(</span><span class="s">&quot; , messages_people mp, &quot;</span><span class="o">+</span>\
               <span class="s">&quot;people_upeople pup, &quot;</span><span class="o">+</span>\
               <span class="n">i_db</span><span class="o">+</span><span class="s">&quot;.countries c, &quot;</span><span class="o">+</span>\
               <span class="n">i_db</span><span class="o">+</span><span class="s">&quot;.upeople_countries upc &quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetMLSSQLCountriesWhere"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLCountriesWhere">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLCountriesWhere</span> <span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c"># filters necessary for the countries analysis</span>

    <span class="k">return</span><span class="p">(</span><span class="s">&quot; m.message_ID = mp.message_id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;mp.email_address = pup.people_id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s"> and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;pup.upeople_id = upc.upeople_id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;upc.country_id = c.id and &quot;</span><span class="o">+</span>\
               <span class="s">&quot;c.name=&quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetMLSSQLDomainsFrom"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLDomainsFrom">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLDomainsFrom</span> <span class="p">(</span><span class="n">i_db</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&quot; , messages_people mp, &quot;</span><span class="o">+</span>\
               <span class="s">&quot;people_upeople pup, &quot;</span><span class="o">+</span>\
              <span class="n">i_db</span><span class="o">+</span><span class="s">&quot;.domains d, &quot;</span><span class="o">+</span>\
              <span class="n">i_db</span><span class="o">+</span><span class="s">&quot;.upeople_domains upd&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetMLSSQLDomainsWhere"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLDomainsWhere">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLDomainsWhere</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&quot; m.message_ID = mp.message_id and &quot;</span><span class="o">+</span>\
                <span class="s">&quot;mp.email_address = pup.people_id and &quot;</span><span class="o">+</span>\
                <span class="s">&quot;mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s"> and &quot;</span><span class="o">+</span>\
                <span class="s">&quot;pup.upeople_id = upd.upeople_id AND &quot;</span><span class="o">+</span>\
                <span class="s">&quot;upd.domain_id = d.id AND &quot;</span><span class="o">+</span>\
                <span class="s">&quot;m.first_date &gt;= upd.init AND &quot;</span><span class="o">+</span>\
                <span class="s">&quot;m.first_date &lt; upd.end and &quot;</span><span class="o">+</span>\
                <span class="s">&quot;d.name=&quot;</span><span class="o">+</span> <span class="n">name</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetSQLProjectsFromMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetSQLProjectsFromMLS">[docs]</a><span class="k">def</span> <span class="nf">GetSQLProjectsFromMLS</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&quot; , mailing_lists ml&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetSQLProjectsWhereMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetSQLProjectsWhereMLS">[docs]</a><span class="k">def</span> <span class="nf">GetSQLProjectsWhereMLS</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">):</span>
    <span class="c"># include all repositories for a project and its subprojects</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="c"># FIXME: why is &quot;&#39;&quot; needed in the name?</span>

    <span class="n">repos</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;and ml.mailing_list_url IN (</span>
<span class="s">           SELECT repository_name</span>
<span class="s">           FROM   </span><span class="si">%s</span><span class="s">.projects p, </span><span class="si">%s</span><span class="s">.project_repositories pr</span>
<span class="s">           WHERE  p.project_id = pr.project_id AND p.project_id IN (</span><span class="si">%s</span><span class="s">)</span>
<span class="s">               AND pr.data_source=&#39;mls&#39;</span>
<span class="s">    )&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">get_subprojects</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">repos</span>  <span class="o">+</span> <span class="s">&quot; and ml.mailing_list_url = m.mailing_list_url&quot;</span><span class="p">)</span>

<span class="c"># Using senders only here!</span></div>
<div class="viewcode-block" id="GetMLSFiltersOwnUniqueIdsMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSFiltersOwnUniqueIdsMLS">[docs]</a><span class="k">def</span> <span class="nf">GetMLSFiltersOwnUniqueIdsMLS</span>  <span class="p">()</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&#39;m.message_ID = mp.message_id AND &#39;</span><span class="o">+</span>\
            <span class="s">&#39; mp.email_address = pup.people_id AND &#39;</span><span class="o">+</span>\
            <span class="s">&#39; mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span>

<span class="c">##########</span>
<span class="c">#Generic functions to obtain FROM and WHERE clauses per type of report</span>
<span class="c">##########</span>
</div>
<div class="viewcode-block" id="GetMLSSQLReportFrom"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLReportFrom">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLReportFrom</span> <span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">):</span>
    <span class="c">#generic function to generate &#39;from&#39; clauses</span>
    <span class="c">#&quot;type&quot; is a list of two values: type of analysis and value of </span>
    <span class="c">#such analysis</span>

    <span class="n">From</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">type_analysis</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span> <span class="k">return</span> <span class="n">From</span>

    <span class="n">analysis</span> <span class="o">=</span> <span class="n">type_analysis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;repository&#39;</span><span class="p">:</span> <span class="n">From</span> <span class="o">=</span> <span class="n">GetMLSSQLRepositoriesFrom</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="n">From</span> <span class="o">=</span> <span class="n">GetMLSSQLCompaniesFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="n">From</span> <span class="o">=</span> <span class="n">GetMLSSQLCountriesFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;domain&#39;</span><span class="p">:</span> <span class="n">From</span> <span class="o">=</span> <span class="n">GetMLSSQLDomainsFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;project&#39;</span><span class="p">:</span> <span class="n">From</span> <span class="o">=</span> <span class="n">GetSQLProjectsFromMLS</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">From</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetMLSSQLReportWhere"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSQLReportWhere">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSQLReportWhere</span> <span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c">#generic function to generate &#39;where&#39; clauses</span>
    <span class="c">#&quot;type&quot; is a list of two values: type of analysis and value of </span>
    <span class="c">#such analysis</span>

    <span class="n">where</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">type_analysis</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span> <span class="k">return</span> <span class="n">where</span>

    <span class="n">analysis</span> <span class="o">=</span> <span class="n">type_analysis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">type_analysis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;repository&#39;</span><span class="p">:</span> <span class="n">where</span> <span class="o">=</span> <span class="n">GetMLSSQLRepositoriesWhere</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;company&#39;</span><span class="p">:</span> <span class="n">where</span> <span class="o">=</span> <span class="n">GetMLSSQLCompaniesWhere</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="n">where</span> <span class="o">=</span> <span class="n">GetMLSSQLCountriesWhere</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;domain&#39;</span><span class="p">:</span> <span class="n">where</span> <span class="o">=</span> <span class="n">GetMLSSQLDomainsWhere</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">analysis</span> <span class="o">==</span> <span class="s">&#39;project&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">identities_db</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;project filter not supported without identities_db&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where</span> <span class="o">=</span> <span class="n">GetSQLProjectsWhereMLS</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">where</span><span class="p">)</span>


<span class="c">#########</span>
<span class="c"># Other generic functions</span>
<span class="c">#########</span>
</div>
<div class="viewcode-block" id="get_projects_mls_name"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.get_projects_mls_name">[docs]</a><span class="k">def</span> <span class="nf">get_projects_mls_name</span><span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="c"># Projects activity needs to include subprojects also</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span> <span class="p">(</span><span class="s">&quot;Getting projects list for MLS&quot;</span><span class="p">)</span>

    <span class="c"># Get all projects list</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT p.id AS name FROM  </span><span class="si">%s</span><span class="s">.projects p&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">identities_db</span><span class="p">)</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># Loop all projects getting reviews</span>
    <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">projects</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;project&#39;</span><span class="p">,</span> <span class="n">project</span><span class="p">]</span>
        <span class="n">period</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">evol</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">sent</span> <span class="o">=</span> <span class="n">GetEmailsSent</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span>
                             <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evol</span><span class="p">)</span>

        <span class="n">sent</span> <span class="o">=</span> <span class="n">sent</span><span class="p">[</span><span class="s">&#39;sent&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sent</span><span class="p">,</span><span class="n">project</span><span class="p">])</span>

    <span class="c"># Order the list using reviews: https://wiki.python.org/moin/HowTo/Sorting</span>
    <span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
    <span class="n">data_sort</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data_sort</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span> <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">names</span>

</div>
<div class="viewcode-block" id="reposField"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.reposField">[docs]</a><span class="k">def</span> <span class="nf">reposField</span> <span class="p">()</span> <span class="p">:</span>
    <span class="c"># Depending on the mailing list, the field to be</span>
    <span class="c"># used is mailing_list or mailing_list_url</span>
    <span class="n">rfield</span> <span class="o">=</span> <span class="s">&#39;mailing_list&#39;</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;select count(distinct(mailing_list)) from messages&quot;</span>
    <span class="n">mailing_lists</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mailing_lists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">rfield</span> <span class="o">=</span> <span class="s">&quot;mailing_list_url&quot;</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">rfield</span><span class="p">);</span>

</div>
<div class="viewcode-block" id="GetMLSFiltersResponse"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSFiltersResponse">[docs]</a><span class="k">def</span> <span class="nf">GetMLSFiltersResponse</span> <span class="p">()</span> <span class="p">:</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters_response</span> <span class="o">=</span> <span class="n">filters</span> <span class="o">+</span> <span class="s">&quot; AND m.is_response_of IS NOT NULL&quot;</span>
    <span class="k">return</span> <span class="n">filters_response</span>

<span class="c">##########</span>
<span class="c"># Meta functions that aggregate all evolutionary or static data in one call</span>
<span class="c">##########</span>

</div>
<div class="viewcode-block" id="GetMLSInfo"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSInfo">[docs]</a><span class="k">def</span> <span class="nf">GetMLSInfo</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">evolutionary</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="n">EvolEmailsSent</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="n">senders</span> <span class="o">=</span> <span class="n">EvolMLSSenders</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">senders</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">senders</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="n">repositories</span> <span class="o">=</span> <span class="n">EvolMLSRepositories</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">repositories</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">repositories</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="n">threads</span> <span class="o">=</span> <span class="n">EvolThreads</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">threads</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="n">sent_response</span> <span class="o">=</span> <span class="n">EvolMLSResponses</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">sent_response</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">sent_response</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="n">senders_response</span> <span class="o">=</span> <span class="n">EvolMLSSendersResponse</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">senders_response</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">senders_response</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="n">senders_init</span> <span class="o">=</span> <span class="n">EvolMLSSendersInit</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">senders_init</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">senders_init</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="n">AggEmailsSent</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">senders</span> <span class="o">=</span> <span class="n">AggMLSSenders</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">repositories</span> <span class="o">=</span> <span class="n">AggMLSRepositories</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">threads</span> <span class="o">=</span> <span class="n">AggThreads</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">sent_response</span> <span class="o">=</span> <span class="n">AggMLSResponses</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">senders_response</span> <span class="o">=</span> <span class="n">AggMLSSendersResponse</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">senders_init</span> <span class="o">=</span> <span class="n">AggMLSSendersInit</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>

        <span class="c"># Data from the last 365 days</span>
        <span class="n">fromdate</span> <span class="o">=</span> <span class="n">GetDates</span><span class="p">(</span><span class="n">enddate</span><span class="p">,</span> <span class="mi">365</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sent_365</span> <span class="o">=</span> <span class="n">AggEmailsSent</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">fromdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">senders_365</span> <span class="o">=</span> <span class="n">AggMLSSenders</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">fromdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">sent</span><span class="p">[</span><span class="s">&#39;sent_365&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sent_365</span><span class="p">[</span><span class="s">&#39;sent&#39;</span><span class="p">]</span>
        <span class="n">senders</span><span class="p">[</span><span class="s">&#39;senders_365&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">senders_365</span><span class="p">[</span><span class="s">&#39;senders&#39;</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sent</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">senders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="o">+</span> <span class="n">repositories</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">threads</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="o">+</span> <span class="n">sent_response</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">senders_response</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">senders_init</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EvolMLSInfo"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSInfo">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSInfo</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c">#Evolutionary info all merged in a dataframe</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSInfo</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="StaticMLSInfo"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.StaticMLSInfo">[docs]</a><span class="k">def</span> <span class="nf">StaticMLSInfo</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c">#Agg info all merged in a dataframe</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSInfo</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

<span class="c">#########</span>
<span class="c">#Functions to obtain info per type of basic piece of data</span>
<span class="c">#########</span>

<span class="c"># All of the EvolXXX or StaticXXX contains the same parameters:</span>
<span class="c">#    period:</span>
<span class="c">#    startdate:</span>
<span class="c">#    enddate:</span>
<span class="c">#    identities_db: MySQL database name</span>
<span class="c">#    type_analysis: tuple with two values: typeof and value</span>
<span class="c">#                   typeof = &#39;companies&#39;, &#39;countries&#39;, &#39;repositories&#39; or &#39;&#39;</span>
<span class="c">#                   value = any value that corresponds with the type of analysis</span>


<span class="c"># Emails Sent</span></div>
<div class="viewcode-block" id="GetEmailsSent"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetEmailsSent">[docs]</a><span class="k">def</span> <span class="nf">GetEmailsSent</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c"># Generic function that counts emails sent</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">evolutionary</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(m.message_ID)) as sent &quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(m.message_ID)) as sent, &quot;</span><span class="o">+</span>\
                  <span class="s">&quot; DATE_FORMAT (min(m.first_date), &#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;) as first_date, &quot;</span><span class="o">+</span>\
                  <span class="s">&quot; DATE_FORMAT (max(m.first_date), &#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;) as last_date &quot;</span>

    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="EvolEmailsSent"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolEmailsSent">[docs]</a><span class="k">def</span> <span class="nf">EvolEmailsSent</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Evolution of emails sent</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetEmailsSent</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="AggEmailsSent"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggEmailsSent">[docs]</a><span class="k">def</span> <span class="nf">AggEmailsSent</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Aggregated number of emails sent</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetEmailsSent</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>


<span class="c"># People sending emails</span></div>
<div class="viewcode-block" id="GetMLSSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSenders">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSenders</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c">#Generic function that counts people sending messages</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(pup.upeople_id)) as senders &quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tables</span> <span class="o">==</span> <span class="s">&quot; messages m &quot;</span><span class="p">):</span>
        <span class="c"># basic case: it&#39;s needed to add unique ids filters</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="n">tables</span> <span class="o">+</span> <span class="s">&quot;, messages_people mp, people_upeople pup &quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#not sure if this line is useful anymore...</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">type_analysis</span> <span class="ow">and</span> <span class="n">type_analysis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;repository&quot;</span><span class="p">,</span> <span class="s">&quot;project&quot;</span><span class="p">)):</span>
        <span class="c">#Adding people_upeople table</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;,  messages_people mp, people_upeople pup &quot;</span>
        <span class="n">filters</span> <span class="o">+=</span> <span class="s">&quot; and m.message_ID = mp.message_id and &quot;</span><span class="o">+</span>\
                   <span class="s">&quot;mp.email_address = pup.people_id and &quot;</span><span class="o">+</span>\
                   <span class="s">&quot;mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s"> &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="EvolMLSSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSSenders">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSSenders</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Evolution of people sending emails</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSSenders</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="AggMLSSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSSenders">[docs]</a><span class="k">def</span> <span class="nf">AggMLSSenders</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Agg of people sending emails</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSSenders</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="GetActiveSendersMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetActiveSendersMLS">[docs]</a><span class="k">def</span> <span class="nf">GetActiveSendersMLS</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">enddate</span><span class="p">):</span>
    <span class="c"># FIXME parameters should be: startdate and enddate</span>
    <span class="c">#Gets people sending messages during last days</span>
    <span class="n">q0</span> <span class="o">=</span> <span class="s">&quot;SELECT distinct(pup.upeople_id) as active_senders&quot;</span> <span class="o">+</span>\
    <span class="s">&quot; FROM messages m,  messages_people mp, people_upeople pup&quot;</span> <span class="o">+</span>\
    <span class="s">&quot; WHERE m.message_ID = mp.message_id AND&quot;</span> <span class="o">+</span>\
    <span class="s">&quot; mp.email_address = pup.people_id AND&quot;</span> <span class="o">+</span>\
    <span class="s">&quot; mp.type_of_recipient=&#39;From&#39; AND &quot;</span><span class="o">+</span>\
    <span class="s">&quot; m.first_date &gt;= (</span><span class="si">%s</span><span class="s"> - INTERVAL </span><span class="si">%s</span><span class="s"> day)&quot;</span>    
    <span class="n">q1</span> <span class="o">=</span> <span class="n">q0</span> <span class="o">%</span> <span class="p">(</span><span class="n">enddate</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetActivePeopleMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetActivePeopleMLS">[docs]</a><span class="k">def</span> <span class="nf">GetActivePeopleMLS</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">enddate</span><span class="p">):</span>
    <span class="c">#Gets list of IDs of people active during last days until enddate</span>
    <span class="n">senders</span> <span class="o">=</span> <span class="n">GetActiveSendersMLS</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="n">senders</span><span class="p">[</span><span class="s">&#39;active_senders&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">active_people</span> <span class="o">=</span> <span class="p">[</span><span class="n">aux</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">active_people</span> <span class="o">=</span> <span class="n">aux</span>
    <span class="k">return</span><span class="p">(</span><span class="n">active_people</span><span class="p">)</span>

<span class="c"># People answering in a thread</span>
</div>
<div class="viewcode-block" id="GetMLSSendersResponse"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSendersResponse">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSendersResponse</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c">#Generic function that counts people sending messages</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(pup.upeople_id)) as senders_response &quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tables</span> <span class="o">==</span> <span class="s">&quot; messages m &quot;</span><span class="p">):</span>
        <span class="c"># basic case: it&#39;s needed to add unique ids filters</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;, messages_people mp, people_upeople pup &quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">type_analysis</span> <span class="ow">and</span> <span class="n">type_analysis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;repository&quot;</span><span class="p">,</span> <span class="s">&quot;project&quot;</span><span class="p">)):</span>
        <span class="c">#Adding people_upeople table</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;,  messages_people mp, people_upeople pup &quot;</span>
        <span class="n">filters</span> <span class="o">+=</span> <span class="s">&quot; and m.message_ID = mp.message_id and &quot;</span><span class="o">+</span>\
                   <span class="s">&quot;mp.email_address = pup.people_id and &quot;</span><span class="o">+</span>\
                   <span class="s">&quot;mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s"> &quot;</span>
    <span class="n">filters</span> <span class="o">+=</span> <span class="s">&quot; and m.is_response_of is not null &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="EvolMLSSendersResponse"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSSendersResponse">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSSendersResponse</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Evolution of people sending emails</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSSendersResponse</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="AggMLSSendersResponse"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSSendersResponse">[docs]</a><span class="k">def</span> <span class="nf">AggMLSSendersResponse</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Agg of people sending emails</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSSendersResponse</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="p">,</span> <span class="bp">False</span><span class="p">))</span>


<span class="c"># People starting threads</span>
</div>
<div class="viewcode-block" id="GetMLSSendersInit"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSSendersInit">[docs]</a><span class="k">def</span> <span class="nf">GetMLSSendersInit</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c">#Generic function that counts people sending messages</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(pup.upeople_id)) as senders_init &quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tables</span> <span class="o">==</span> <span class="s">&quot; messages m &quot;</span><span class="p">):</span>
        <span class="c"># basic case: it&#39;s needed to add unique ids filters</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;, messages_people mp, people_upeople pup &quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">type_analysis</span> <span class="ow">and</span> <span class="n">type_analysis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;repository&quot;</span><span class="p">,</span> <span class="s">&quot;project&quot;</span><span class="p">)):</span>
        <span class="c">#Adding people_upeople table</span>
        <span class="n">tables</span> <span class="o">+=</span> <span class="s">&quot;,  messages_people mp, people_upeople pup &quot;</span>
        <span class="n">filters</span> <span class="o">+=</span> <span class="s">&quot; and m.message_ID = mp.message_id and &quot;</span><span class="o">+</span>\
                   <span class="s">&quot; mp.email_address = pup.people_id and &quot;</span><span class="o">+</span>\
                   <span class="s">&quot; mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s"> &quot;</span>
    <span class="n">filters</span> <span class="o">+=</span> <span class="s">&quot; and m.is_response_of is null &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="EvolMLSSendersInit"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSSendersInit">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSSendersInit</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Evolution of people sending emails</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSSendersInit</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="AggMLSSendersInit"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSSendersInit">[docs]</a><span class="k">def</span> <span class="nf">AggMLSSendersInit</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Agg of people sending emails</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSSendersInit</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

<span class="c"># Threads</span></div>
<div class="viewcode-block" id="GetThreads"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetThreads">[docs]</a><span class="k">def</span> <span class="nf">GetThreads</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c"># Generic function that counts threads</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(m.is_response_of)) as threads&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="EvolThreads"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolThreads">[docs]</a><span class="k">def</span> <span class="nf">EvolThreads</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Aggregated number of emails sent</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetThreads</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="AggThreads"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggThreads">[docs]</a><span class="k">def</span> <span class="nf">AggThreads</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Aggregated number of emails sent</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetThreads</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

<span class="c"># Repositories</span></div>
<div class="viewcode-block" id="GetMLSRepositories"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSRepositories">[docs]</a><span class="k">def</span> <span class="nf">GetMLSRepositories</span> <span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c"># Generic function that counts threads</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; COUNT(DISTINCT(m.&quot;</span><span class="o">+</span><span class="n">rfield</span><span class="o">+</span><span class="s">&quot;)) AS repositories  &quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="EvolMLSRepositories"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSRepositories">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSRepositories</span> <span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Aggregated number of emails sent</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSRepositories</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="AggMLSRepositories"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSRepositories">[docs]</a><span class="k">def</span> <span class="nf">AggMLSRepositories</span> <span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Aggregated number of emails sent</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSRepositories</span><span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

<span class="c"># Messages replying a thread</span></div>
<div class="viewcode-block" id="GetMLSResponses"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSResponses">[docs]</a><span class="k">def</span> <span class="nf">GetMLSResponses</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c"># Generic function that counts replies</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(m.message_ID)) as sent_response&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; and m.is_response_of is not null &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="EvolMLSResponses"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSResponses">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSResponses</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Evol number of replies</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSResponses</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="AggMLSResponses"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSResponses">[docs]</a><span class="k">def</span> <span class="nf">AggMLSResponses</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Aggregated number of emails replied</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSResponses</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

<span class="c"># Messages starting threads</span></div>
<div class="viewcode-block" id="GetMLSInit"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSInit">[docs]</a><span class="k">def</span> <span class="nf">GetMLSInit</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">):</span>
    <span class="c"># Generic function that counts replies</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; count(distinct(m.message_ID)) as sent_init&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; m.is_response_of is null &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="EvolMLSInit"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSInit">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSInit</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Evol number of messages starting a thread</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSInit</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="AggMLSInit"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSInit">[docs]</a><span class="k">def</span> <span class="nf">AggMLSInit</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[]):</span>
    <span class="c"># Aggregated number of emails starting a thread</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSInit</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="GetMLSStudies"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetMLSStudies">[docs]</a><span class="k">def</span> <span class="nf">GetMLSStudies</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">,</span> <span class="n">study</span><span class="p">):</span>
    <span class="c"># Generic function that counts evolution/agg number of specific studies with similar</span>
    <span class="c"># database schema such as domains, companies and countries</span>

    <span class="n">fields</span> <span class="o">=</span> <span class="s">&#39; count(distinct(name)) as &#39;</span> <span class="o">+</span> <span class="n">study</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="s">&quot; messages m &quot;</span> <span class="o">+</span> <span class="n">GetMLSSQLReportFrom</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetMLSSQLReportWhere</span><span class="p">(</span><span class="n">type_analysis</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; and m.is_response_of is null &quot;</span>

    <span class="c">#Filtering last part of the query, not used in this case</span>
    <span class="c">#filters = gsub(&quot;and\n( )+(d|c|cou|com).name =.*$&quot;, &quot;&quot;, filters)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">BuildQuery</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="s">&quot; m.first_date &quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">evolutionary</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;(d|c|cou|com).name.*and&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="EvolMLSDomains"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSDomains">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSDomains</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">):</span>
    <span class="c"># Evol number of domains used</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSStudies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;domain&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;domains&#39;</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="EvolMLSCountries"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSCountries">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSCountries</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">):</span>
    <span class="c"># Evol number of countries</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSStudies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;countries&#39;</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="EvolMLSCompanies"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.EvolMLSCompanies">[docs]</a><span class="k">def</span> <span class="nf">EvolMLSCompanies</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">):</span>
    <span class="c"># Evol number of companies</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">GetMLSStudies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;company&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;companies&#39;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AggMLSDomains"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSDomains">[docs]</a><span class="k">def</span> <span class="nf">AggMLSDomains</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">):</span>
    <span class="c"># Agg number of domains</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSStudies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;domain&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;domains&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="AggMLSCountries"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSCountries">[docs]</a><span class="k">def</span> <span class="nf">AggMLSCountries</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">):</span>
    <span class="c"># Agg number of countries</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSStudies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;countries&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="AggMLSCompanies"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.AggMLSCompanies">[docs]</a><span class="k">def</span> <span class="nf">AggMLSCompanies</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">):</span>
    <span class="c"># Agg number of companies</span>
    <span class="k">return</span><span class="p">(</span><span class="n">GetMLSStudies</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;company&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">],</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;companies&#39;</span><span class="p">))</span>


<span class="c">####################</span>
<span class="c"># Lists of repositories, companies, countries, etc</span>
<span class="c"># Functions to obtain list of names (of repositories) per type of analysis</span>
<span class="c">####################</span>


<span class="c"># WARNING: Functions directly copied from old MLS.R</span>
</div>
<div class="viewcode-block" id="reposNames"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.reposNames">[docs]</a><span class="k">def</span> <span class="nf">reposNames</span>  <span class="p">(</span><span class="n">rfield</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">names</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rfield</span> <span class="o">==</span> <span class="s">&quot;mailing_list_url&quot;</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT ml.mailing_list_url, COUNT(message_ID) AS total &quot;</span><span class="o">+</span>\
               <span class="s">&quot;FROM messages m, mailing_lists ml &quot;</span><span class="o">+</span>\
               <span class="s">&quot;WHERE m.mailing_list_url = ml.mailing_list_url AND &quot;</span><span class="o">+</span>\
               <span class="s">&quot;m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
               <span class="s">&quot;m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span>\
               <span class="s">&quot;GROUP BY ml.mailing_list_url ORDER by total desc&quot;</span>
        <span class="n">mailing_lists</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">mailing_lists_files</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">mailing_lists_files</span><span class="p">[</span><span class="n">rfield</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># TODO: not ordered yet by total messages</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT DISTINCT(mailing_list) FROM messages m &quot;</span><span class="o">+</span>\
            <span class="s">&quot;WHERE m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span>
        <span class="n">mailing_lists</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">mailing_lists</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="countriesNames"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.countriesNames">[docs]</a><span class="k">def</span> <span class="nf">countriesNames</span>  <span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">filter_</span><span class="o">=</span><span class="p">[])</span> <span class="p">:</span>
    <span class="n">countries_limit</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="n">filter_countries</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">filter_</span><span class="p">:</span>
        <span class="n">filter_countries</span> <span class="o">+=</span> <span class="s">&quot; c.name&lt;&gt;&#39;&quot;</span><span class="o">+</span><span class="n">country</span><span class="o">+</span><span class="s">&quot;&#39; AND &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT c.name as name, COUNT(m.message_ID) as sent &quot;</span><span class="o">+</span>\
            <span class="s">&quot;FROM &quot;</span><span class="o">+</span> <span class="n">GetTablesCountries</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
            <span class="s">&quot;WHERE &quot;</span><span class="o">+</span> <span class="n">GetFiltersCountries</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  &quot;</span><span class="o">+</span> <span class="n">filter_countries</span><span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span>\
            <span class="s">&quot;GROUP BY c.name &quot;</span><span class="o">+</span>\
            <span class="s">&quot;ORDER BY COUNT((m.message_ID)) DESC LIMIT &quot;</span><span class="o">+</span>\
            <span class="nb">str</span><span class="p">(</span><span class="n">countries_limit</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="companiesNames"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.companiesNames">[docs]</a><span class="k">def</span> <span class="nf">companiesNames</span>  <span class="p">(</span><span class="n">i_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">filter_</span><span class="o">=</span><span class="p">[])</span> <span class="p">:</span>
    <span class="n">companies_limit</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">filter_companies</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">filter_</span><span class="p">:</span>
        <span class="n">filter_companies</span> <span class="o">+=</span> <span class="s">&quot; c.name&lt;&gt;&#39;&quot;</span><span class="o">+</span><span class="n">company</span><span class="o">+</span><span class="s">&quot;&#39; AND &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT c.name as name, COUNT(DISTINCT(m.message_ID)) as sent &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    FROM &quot;</span><span class="o">+</span> <span class="n">GetTablesCompanies</span><span class="p">(</span><span class="n">i_db</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    WHERE &quot;</span><span class="o">+</span> <span class="n">GetFiltersCompanies</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      &quot;</span><span class="o">+</span> <span class="n">filter_companies</span><span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    GROUP BY c.name &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    ORDER BY COUNT(DISTINCT(m.message_ID)) DESC LIMIT &quot;</span> <span class="o">+</span>\
        <span class="nb">str</span><span class="p">(</span><span class="n">companies_limit</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="domainsNames"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.domainsNames">[docs]</a><span class="k">def</span> <span class="nf">domainsNames</span>  <span class="p">(</span><span class="n">i_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">filter_</span><span class="o">=</span><span class="p">[])</span> <span class="p">:</span>
    <span class="n">domains_limit</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">filter_domains</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">filter_</span><span class="p">:</span>
        <span class="n">filter_domains</span> <span class="o">+=</span> <span class="s">&quot; d.name&lt;&gt;&#39;&quot;</span><span class="o">+</span> <span class="n">domain</span> <span class="o">+</span> <span class="s">&quot;&#39; AND &quot;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT d.name as name, COUNT(DISTINCT(m.message_ID)) as sent &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    FROM &quot;</span><span class="o">+</span><span class="n">GetTablesDomains</span><span class="p">(</span><span class="n">i_db</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    WHERE &quot;</span><span class="o">+</span> <span class="n">GetFiltersDomains</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    &quot;</span><span class="o">+</span> <span class="n">filter_domains</span><span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span>\
        <span class="s">&quot;    GROUP BY d.name &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    ORDER BY COUNT(DISTINCT(m.message_ID)) DESC LIMIT &quot;</span><span class="o">+</span>\
            <span class="nb">str</span><span class="p">(</span><span class="n">domains_limit</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

<span class="c">########################</span>
<span class="c"># People functions as in the old version, still to be refactored!</span>
<span class="c">########################</span>
</div>
<div class="viewcode-block" id="GetTablesOwnUniqueIdsMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetTablesOwnUniqueIdsMLS">[docs]</a><span class="k">def</span> <span class="nf">GetTablesOwnUniqueIdsMLS</span> <span class="p">()</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&#39;messages m, messages_people mp, people_upeople pup&#39;</span><span class="p">)</span>


<span class="c"># Using senders only here!</span></div>
<div class="viewcode-block" id="GetFiltersOwnUniqueIdsMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetFiltersOwnUniqueIdsMLS">[docs]</a><span class="k">def</span> <span class="nf">GetFiltersOwnUniqueIdsMLS</span>  <span class="p">()</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&#39;m.message_ID = mp.message_id AND &#39;</span><span class="o">+</span>\
             <span class="s">&quot;mp.email_address = pup.people_id AND &quot;</span><span class="o">+</span>\
             <span class="s">&#39;mp.type_of_recipient=</span><span class="se">\&#39;</span><span class="s">From</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetTablesCountries"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetTablesCountries">[docs]</a><span class="k">def</span> <span class="nf">GetTablesCountries</span> <span class="p">(</span><span class="n">i_db</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span>\
                  <span class="n">i_db</span><span class="o">+</span><span class="s">&#39;.countries c, &#39;</span><span class="o">+</span>\
                  <span class="n">i_db</span><span class="o">+</span><span class="s">&#39;.upeople_countries upc&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetFiltersCountries"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetFiltersCountries">[docs]</a><span class="k">def</span> <span class="nf">GetFiltersCountries</span> <span class="p">()</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; AND &#39;</span><span class="o">+</span>\
              <span class="s">&quot;pup.upeople_id = upc.upeople_id AND &quot;</span><span class="o">+</span>\
              <span class="s">&#39;upc.country_id = c.id&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetTablesCompanies"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetTablesCompanies">[docs]</a><span class="k">def</span> <span class="nf">GetTablesCompanies</span> <span class="p">(</span><span class="n">i_db</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span>\
                  <span class="n">i_db</span><span class="o">+</span><span class="s">&#39;.companies c, &#39;</span><span class="o">+</span>\
                  <span class="n">i_db</span><span class="o">+</span><span class="s">&#39;.upeople_companies upc&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetFiltersCompanies"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetFiltersCompanies">[docs]</a><span class="k">def</span> <span class="nf">GetFiltersCompanies</span> <span class="p">()</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; AND &#39;</span><span class="o">+</span>\
                  <span class="s">&quot;pup.upeople_id = upc.upeople_id AND &quot;</span><span class="o">+</span>\
                  <span class="s">&quot;upc.company_id = c.id AND &quot;</span><span class="o">+</span>\
                  <span class="s">&quot;m.first_date &gt;= upc.init AND &quot;</span><span class="o">+</span>\
                  <span class="s">&#39;m.first_date &lt; upc.end&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetTablesDomains"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetTablesDomains">[docs]</a><span class="k">def</span> <span class="nf">GetTablesDomains</span> <span class="p">(</span><span class="n">i_db</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;, &#39;</span><span class="o">+</span>\
                  <span class="n">i_db</span><span class="o">+</span><span class="s">&#39;.domains d, &#39;</span><span class="o">+</span>\
                  <span class="n">i_db</span><span class="o">+</span><span class="s">&#39;.upeople_domains upd&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetFiltersDomains"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetFiltersDomains">[docs]</a><span class="k">def</span> <span class="nf">GetFiltersDomains</span> <span class="p">()</span> <span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; AND &#39;</span><span class="o">+</span>\
                  <span class="s">&quot;pup.upeople_id = upd.upeople_id AND &quot;</span><span class="o">+</span>\
                  <span class="s">&quot;upd.domain_id = d.id AND &quot;</span><span class="o">+</span>\
                  <span class="s">&quot;m.first_date &gt;= upd.init AND &quot;</span><span class="o">+</span>\
                  <span class="s">&#39;m.first_date &lt; upd.end&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetFiltersInit"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetFiltersInit">[docs]</a><span class="k">def</span> <span class="nf">GetFiltersInit</span> <span class="p">()</span> <span class="p">:</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters_init</span> <span class="o">=</span> <span class="n">filters</span> <span class="o">+</span> <span class="s">&quot; AND m.is_response_of IS NULL&quot;</span>
    <span class="k">return</span> <span class="n">filters_init</span>
</div>
<div class="viewcode-block" id="GetFiltersResponse"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetFiltersResponse">[docs]</a><span class="k">def</span> <span class="nf">GetFiltersResponse</span> <span class="p">()</span> <span class="p">:</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters_response</span> <span class="o">=</span> <span class="n">filters</span> <span class="o">+</span> <span class="s">&quot; AND m.is_response_of IS NOT NULL&quot;</span>
    <span class="k">return</span> <span class="n">filters_response</span>
</div>
<div class="viewcode-block" id="GetListPeopleMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetListPeopleMLS">[docs]</a><span class="k">def</span> <span class="nf">GetListPeopleMLS</span> <span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot;DISTINCT(pup.upeople_id) as id, count(m.message_ID) total&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">+=</span> <span class="s">&quot; GROUP BY id ORDER BY total desc&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">GetSQLGlobal</span><span class="p">(</span><span class="s">&#39;first_date&#39;</span><span class="p">,</span><span class="n">fields</span><span class="p">,</span><span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetQueryPeopleMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetQueryPeopleMLS">[docs]</a><span class="k">def</span> <span class="nf">GetQueryPeopleMLS</span> <span class="p">(</span><span class="n">developer_id</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">evol</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot;COUNT(m.message_ID) AS sent&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;AND pup.upeople_id = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">developer_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">evol</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">GetSQLPeriod</span><span class="p">(</span><span class="n">period</span><span class="p">,</span><span class="s">&#39;first_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span>
                <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span> <span class="o">+</span>\
                <span class="s">&quot;,DATE_FORMAT (min(first_date),&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;) as first_date, &quot;</span><span class="o">+</span>\
                <span class="s">&quot;DATE_FORMAT (max(first_date),&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;) as last_date&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">GetSQLGlobal</span><span class="p">(</span><span class="s">&#39;first_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span>
                <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetEvolPeopleMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetEvolPeopleMLS">[docs]</a><span class="k">def</span> <span class="nf">GetEvolPeopleMLS</span> <span class="p">(</span><span class="n">developer_id</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">GetQueryPeopleMLS</span><span class="p">(</span><span class="n">developer_id</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GetStaticPeopleMLS"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetStaticPeopleMLS">[docs]</a><span class="k">def</span> <span class="nf">GetStaticPeopleMLS</span> <span class="p">(</span><span class="n">developer_id</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">GetQueryPeopleMLS</span><span class="p">(</span><span class="n">developer_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="c">#########################</span>
<span class="c"># Top activity developers</span>
<span class="c">#########################</span>

</div>
<div class="viewcode-block" id="top_senders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.top_senders">[docs]</a><span class="k">def</span> <span class="nf">top_senders</span> <span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">filter_</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span> <span class="p">:</span>

    <span class="n">affiliations</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">filter_</span><span class="p">):</span> <span class="n">filter_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">aff</span> <span class="ow">in</span> <span class="n">filter_</span><span class="p">:</span>
        <span class="n">affiliations</span> <span class="o">=</span> <span class="n">affiliations</span><span class="o">+</span> <span class="s">&quot; c.name&lt;&gt;&#39;&quot;</span><span class="o">+</span> <span class="n">aff</span> <span class="o">+</span><span class="s">&quot;&#39; and &quot;</span>

    <span class="n">date_limit</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">days</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;SELECT @maxdate:=max(first_date) from messages limit 1&quot;</span>
        <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">date_limit</span> <span class="o">=</span> <span class="s">&quot; AND DATEDIFF(@maxdate,first_date)&lt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT up.id as id, up.identifier as senders, &quot;</span><span class="o">+</span>\
            <span class="s">&quot;COUNT(distinct(m.message_id)) as sent &quot;</span><span class="o">+</span>\
            <span class="s">&quot;FROM &quot;</span><span class="o">+</span> <span class="n">GetTablesCompanies</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span><span class="o">+</span>\
            <span class="s">&quot; ,&quot;</span><span class="o">+</span><span class="n">identities_db</span><span class="o">+</span><span class="s">&quot;.upeople up &quot;</span><span class="o">+</span>\
            <span class="s">&quot;WHERE &quot;</span><span class="o">+</span> <span class="n">GetFiltersCompanies</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  pup.upeople_id = up.id AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  &quot;</span><span class="o">+</span> <span class="n">affiliations</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span> <span class="o">+</span>\
            <span class="n">date_limit</span><span class="o">+</span> <span class="s">&quot; &quot;</span><span class="o">+</span>\
            <span class="s">&quot;GROUP BY up.identifier &quot;</span><span class="o">+</span>\
            <span class="s">&quot;ORDER BY sent desc, senders &quot;</span><span class="o">+</span>\
            <span class="s">&quot;LIMIT &quot;</span> <span class="o">+</span> <span class="n">limit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="repoTopSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.repoTopSenders">[docs]</a><span class="k">def</span> <span class="nf">repoTopSenders</span> <span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">rfield</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT up.id as id, up.identifier as senders, &quot;</span><span class="o">+</span>\
            <span class="s">&quot;COUNT(m.message_id) as sent &quot;</span><span class="o">+</span>\
            <span class="s">&quot;FROM &quot;</span><span class="o">+</span> <span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot;,&quot;</span><span class="o">+</span><span class="n">identities_db</span><span class="o">+</span><span class="s">&quot;.upeople up &quot;</span><span class="o">+</span>\
            <span class="s">&quot;WHERE &quot;</span><span class="o">+</span> <span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  pup.upeople_id = up.id AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
            <span class="s">&quot;  m.&quot;</span><span class="o">+</span><span class="n">rfield</span><span class="o">+</span><span class="s">&quot;=&#39;&quot;</span><span class="o">+</span><span class="n">repo</span><span class="o">+</span><span class="s">&quot;&#39; &quot;</span><span class="o">+</span>\
            <span class="s">&quot;GROUP BY up.identifier &quot;</span><span class="o">+</span>\
            <span class="s">&quot;ORDER BY sent desc &quot;</span><span class="o">+</span>\
            <span class="s">&quot;LIMIT &quot;</span> <span class="o">+</span> <span class="n">limit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="countryTopSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.countryTopSenders">[docs]</a><span class="k">def</span> <span class="nf">countryTopSenders</span> <span class="p">(</span><span class="n">country_name</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT up.id as id, up.identifier as senders, &quot;</span><span class="o">+</span>\
        <span class="s">&quot;COUNT(DISTINCT(m.message_id)) as sent &quot;</span><span class="o">+</span>\
        <span class="s">&quot;FROM &quot;</span><span class="o">+</span> <span class="n">GetTablesCountries</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span><span class="o">+</span> \
        <span class="s">&quot;  , &quot;</span><span class="o">+</span><span class="n">identities_db</span><span class="o">+</span><span class="s">&quot;.upeople up &quot;</span><span class="o">+</span>\
        <span class="s">&quot;WHERE &quot;</span><span class="o">+</span> <span class="n">GetFiltersCountries</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  up.id = upc.upeople_id AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  c.name = &#39;&quot;</span><span class="o">+</span><span class="n">country_name</span><span class="o">+</span><span class="s">&quot;&#39; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;GROUP BY up.identifier &quot;</span><span class="o">+</span>\
        <span class="s">&quot;ORDER BY COUNT(DISTINCT(m.message_ID)) DESC LIMIT &quot;</span> <span class="o">+</span> <span class="n">limit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="companyTopSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.companyTopSenders">[docs]</a><span class="k">def</span> <span class="nf">companyTopSenders</span> <span class="p">(</span><span class="n">company_name</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT up.id as id, up.identifier as senders, &quot;</span><span class="o">+</span>\
        <span class="s">&quot;COUNT(DISTINCT(m.message_id)) as sent &quot;</span><span class="o">+</span>\
        <span class="s">&quot;FROM &quot;</span><span class="o">+</span><span class="n">GetTablesCompanies</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span><span class="o">+</span>\
        <span class="s">&quot;, &quot;</span><span class="o">+</span><span class="n">identities_db</span><span class="o">+</span><span class="s">&quot;.upeople up &quot;</span><span class="o">+</span>\
        <span class="s">&quot;WHERE &quot;</span><span class="o">+</span><span class="n">GetFiltersCompanies</span><span class="p">()</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  up.id = upc.upeople_id AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  c.name = &#39;&quot;</span><span class="o">+</span><span class="n">company_name</span><span class="o">+</span><span class="s">&quot;&#39; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;GROUP BY up.identifier &quot;</span><span class="o">+</span>\
        <span class="s">&quot;ORDER BY COUNT(DISTINCT(m.message_ID)) DESC LIMIT &quot;</span> <span class="o">+</span> <span class="n">limit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="domainTopSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.domainTopSenders">[docs]</a><span class="k">def</span> <span class="nf">domainTopSenders</span> <span class="p">(</span><span class="n">domain_name</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;SELECT up.identifier as senders, &quot;</span><span class="o">+</span>\
        <span class="s">&quot;COUNT(DISTINCT(m.message_id)) as sent &quot;</span><span class="o">+</span>\
        <span class="s">&quot;FROM &quot;</span><span class="o">+</span><span class="n">GetTablesDomains</span><span class="p">(</span><span class="n">identities_db</span><span class="p">)</span> <span class="o">+</span>\
        <span class="s">&quot; , &quot;</span><span class="o">+</span><span class="n">identities_db</span><span class="o">+</span><span class="s">&quot;.upeople up &quot;</span><span class="o">+</span>\
        <span class="s">&quot;WHERE &quot;</span><span class="o">+</span><span class="n">GetFiltersDomains</span><span class="p">()</span><span class="o">+</span> <span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  up.id = upd.upeople_id AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  m.first_date &gt;= &quot;</span><span class="o">+</span><span class="n">startdate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  m.first_date &lt; &quot;</span><span class="o">+</span><span class="n">enddate</span><span class="o">+</span><span class="s">&quot; AND &quot;</span><span class="o">+</span>\
        <span class="s">&quot;  d.name = &#39;&quot;</span><span class="o">+</span><span class="n">domain_name</span><span class="o">+</span><span class="s">&quot;&#39; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;GROUP BY up.identifier &quot;</span><span class="o">+</span>\
        <span class="s">&quot;ORDER BY COUNT(DISTINCT(m.message_ID)) DESC LIMIT &quot;</span><span class="o">+</span> <span class="n">limit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="c">#######################</span>
<span class="c"># Functions to analyze last activity</span>
<span class="c">#######################</span>
</div>
<div class="viewcode-block" id="lastActivity"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.lastActivity">[docs]</a><span class="k">def</span> <span class="nf">lastActivity</span> <span class="p">(</span><span class="n">days</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">days</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)</span>
    <span class="c">#commits</span>
    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;select count(distinct(message_ID)) as sent_&quot;</span><span class="o">+</span><span class="n">days</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    from messages &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    where first_date &gt;= ( &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      select (max(first_date) - INTERVAL &quot;</span><span class="o">+</span><span class="n">days</span><span class="o">+</span><span class="s">&quot; day) &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      from messages)&quot;</span>

    <span class="n">data1</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">q</span> <span class="o">=</span> <span class="s">&quot;select count(distinct(pup.upeople_id)) as senders_&quot;</span><span class="o">+</span><span class="n">days</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    from messages m, &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      people_upeople pup, &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      messages_people mp &quot;</span><span class="o">+</span>\
        <span class="s">&quot;    where pup.people_id = mp.email_address  and &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      m.message_ID = mp.message_id and &quot;</span><span class="o">+</span>\
        <span class="s">&quot;      m.first_date &gt;= (select (max(first_date) - INTERVAL &quot;</span><span class="o">+</span><span class="n">days</span><span class="o">+</span><span class="s">&quot; day) &quot;</span><span class="o">+</span>\
        <span class="s">&quot;        from messages)&quot;</span>

    <span class="n">data2</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">agg_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">data2</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">return</span><span class="p">(</span><span class="n">agg_data</span><span class="p">)</span>

<span class="c">#####################</span>
<span class="c"># MICRO STUDIES</span>
<span class="c">#####################</span>
</div>
<div class="viewcode-block" id="StaticNumSent"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.StaticNumSent">[docs]</a><span class="k">def</span> <span class="nf">StaticNumSent</span> <span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; COUNT(*) as sent &quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">GetSQLGlobal</span><span class="p">(</span><span class="s">&#39;first_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span>
            <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
    <span class="n">sent</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sent</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="StaticNumSenders"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.StaticNumSenders">[docs]</a><span class="k">def</span> <span class="nf">StaticNumSenders</span> <span class="p">(</span><span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="s">&quot; COUNT(DISTINCT(pup.upeople_id)) as senders &quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">GetTablesOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">GetFiltersOwnUniqueIdsMLS</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">GetSQLGlobal</span><span class="p">(</span><span class="s">&#39;first_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span>
            <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
    <span class="n">senders</span> <span class="o">=</span> <span class="n">ExecuteQuery</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">senders</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetDiffSentDays"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetDiffSentDays">[docs]</a><span class="k">def</span> <span class="nf">GetDiffSentDays</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">init_date</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
    <span class="n">chardates</span> <span class="o">=</span> <span class="n">GetDates</span><span class="p">(</span><span class="n">init_date</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">StaticNumSent</span><span class="p">(</span><span class="n">chardates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chardates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="s">&#39;sent&#39;</span><span class="p">])</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">StaticNumSent</span><span class="p">(</span><span class="n">chardates</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">chardates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="s">&#39;sent&#39;</span><span class="p">])</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&#39;diff_netsent_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)]</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="n">prev</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&#39;percentage_sent_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)]</span> <span class="o">=</span> <span class="n">GetPercentageDiff</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&#39;sent_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)]</span> <span class="o">=</span> <span class="n">last</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetDiffSendersDays"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetDiffSendersDays">[docs]</a><span class="k">def</span> <span class="nf">GetDiffSendersDays</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">init_date</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
    <span class="c"># This function provides the percentage in activity between two periods</span>

    <span class="n">chardates</span> <span class="o">=</span> <span class="n">GetDates</span><span class="p">(</span><span class="n">init_date</span><span class="p">,</span> <span class="n">days</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">StaticNumSenders</span><span class="p">(</span><span class="n">chardates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chardates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">[</span><span class="s">&#39;senders&#39;</span><span class="p">])</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="n">StaticNumSenders</span><span class="p">(</span><span class="n">chardates</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">chardates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="s">&#39;senders&#39;</span><span class="p">])</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&#39;diff_netsenders_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)]</span> <span class="o">=</span> <span class="n">last</span> <span class="o">-</span> <span class="n">prev</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&#39;percentage_senders_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)]</span> <span class="o">=</span> <span class="n">GetPercentageDiff</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">last</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&#39;senders_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">days</span><span class="p">)]</span> <span class="o">=</span> <span class="n">last</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GetSentSummaryCompanies"><a class="viewcode-back" href="../../vizgrimoire.MLS.html#vizgrimoire.MLS.GetSentSummaryCompanies">[docs]</a><span class="k">def</span> <span class="nf">GetSentSummaryCompanies</span> <span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">num_companies</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">first_companies</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">companies</span>  <span class="o">=</span> <span class="n">companiesNames</span><span class="p">(</span><span class="n">identities_db</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;-Bot&quot;</span><span class="p">,</span> <span class="s">&quot;-Individual&quot;</span><span class="p">,</span> <span class="s">&quot;-Unknown&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">companies</span><span class="p">:</span>
        <span class="n">type_analysis</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;company&quot;</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">company</span><span class="o">+</span><span class="s">&quot;&#39;&quot;</span><span class="p">]</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="n">EvolEmailsSent</span><span class="p">(</span><span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">,</span> <span class="n">identities_db</span><span class="p">,</span> <span class="n">type_analysis</span><span class="p">)</span>
        <span class="n">sent</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">sent</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>
        <span class="c"># Rename field sent to company name</span>
        <span class="n">sent</span><span class="p">[</span><span class="n">company</span><span class="p">]</span> <span class="o">=</span> <span class="n">sent</span><span class="p">[</span><span class="s">&quot;sent&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">sent</span><span class="p">[</span><span class="s">&#39;sent&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">num_companies</span><span class="p">):</span>
            <span class="c">#Case of companies with entity in the dataset</span>
            <span class="n">first_companies</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">first_companies</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">sent</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="c">#Case of companies that are aggregated in the field Others</span>
            <span class="k">if</span> <span class="s">&#39;Others&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">first_companies</span><span class="p">:</span>
                <span class="n">first_companies</span><span class="p">[</span><span class="s">&#39;Others&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sent</span><span class="p">[</span><span class="n">company</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first_companies</span><span class="p">[</span><span class="s">&#39;Others&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">first_companies</span><span class="p">[</span><span class="s">&#39;Others&#39;</span><span class="p">],</span><span class="n">sent</span><span class="p">[</span><span class="n">company</span><span class="p">])]</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">first_companies</span> <span class="o">=</span> <span class="n">completePeriodIds</span><span class="p">(</span><span class="n">first_companies</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">startdate</span><span class="p">,</span> <span class="n">enddate</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">first_companies</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">GrimoreLib 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Bitergia.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>